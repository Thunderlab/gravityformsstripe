window.GFStripe=null,function(c){GFStripe=function(e){for(var r in e)e.hasOwnProperty(r)&&(this[r]=e[r]);this.form=null,this.init=function(){if(this.isCreditCardOnPage()||"checkout"===this.stripe_payment){var o=this,d=null,g=!1,i=!1,a=o.apiKey;switch(gform.addAction("gform_frontend_feeds_evaluated",function(e,r){d=null,i=g=!1;for(var t=0;t<Object.keys(e).length;t++)if("gravityformsstripe"===e[t].addonSlug&&e[t].isActivated){switch(g=!0,d=o.feeds[t],a=d.hasOwnProperty("apiKey")?d.apiKey:o.apiKey,o.stripe_payment){case"elements":_=Stripe(a),s=_.elements(),i=""!==d.address_zip,0<=s._elements.indexOf("card")&&m.destroy(),c(p).next(".validation_message").length&&c(p).next(".validation_message").html(""),(m=s.create("card",{classes:o.cardClasses,style:o.cardStyle,hidePostalCode:i})).mount(p),m.on("change",function(e){o.displayStripeCardError(e)});break;case"checkout":void 0!==n&&n.close(),f.key=a,n=StripeCheckout.configure(f),"form_total"===d.paymentAmount&&(gform.addFilter("gform_product_total",function(e,r){return window["gform_stripe_checkout_amount_"+r]=e},51),gformCalculateTotalPrice(r)),o.updateCheckoutPaymentAmount(d);break;case"stripe.js":Stripe.setPublishableKey(a)}break}if(!g){if("elements"===o.stripe_payment)null!==s&&0<=s._elements.indexOf("card")&&m.destroy(),c(p).next(".validation_message").length||c(p).after('<div class="gfield_description validation_message"></div>'),c(p).next(".validation_message").html(gforms_stripe_frontend_strings.no_active_frontend_feed);o.form=c("#gform_"+r),o.resetStripeStatus(o.form,r,o.isLastPage()),a=o.apiKey}}),o.stripe_payment){case"elements":var _=null,s=null,p="#input_"+o.formId+"_"+o.ccFieldId+"_1",m=null,l=!1;break;case"checkout":var n,r=c("#gform_"+this.formId),f={key:a,token:function(e){c("#gf_stripe_response").length?c("#gf_stripe_response").val(c.toJSON(e)):r.append(c('<input type="hidden" name="stripe_response" id="gf_stripe_response" />').val(c.toJSON(e))),r.submit()}};c(document).on("gform_price_change",function(){c("#gf_stripe_response").length&&c("#gf_stripe_response").val(""),o.updateCheckoutPaymentAmount(d)}),c("#gform_submit_button_"+this.formId).on("click",function(e){if(g&&!r.data("gfstripesubmitting")){if(c("#gf_stripe_response").length&&""!==c("#gf_stripe_response").val())if(c.parseJSON(c("#gf_stripe_response").val()).id)return void r.submit();(f={amount:0===gf_global.gf_currency_config.decimals?window["gform_stripe_checkout_amount_"+o.formId]:100*window["gform_stripe_checkout_amount_"+o.formId],currency:gform.applyFilters("gform_stripe_currency",o.currency,o.formId),locale:"auto",image:d.logoUrl,name:GFMergeTag.replaceMergeTags(o.formId,d.name),description:GFMergeTag.replaceMergeTags(o.formId,d.description),zipCode:!0}).billingAddress=d.billingAddress,0<(f=gform.applyFilters("gform_stripe_checkout_options",f,o.formId)).amount&&(e.preventDefault(),f.amount=Math.round(f.amount),n.open(f))}}),window.addEventListener("popstate",function(){n.close()})}c("#gform_"+this.formId).submit(function(e){if(("stripe.js"===o.stripe_payment||g)&&!(c(this).data("gfstripesubmitting")||1==c("#gform_save_"+o.formId).val()||!o.isLastPage()&&"elements"!==o.stripe_payment||gformIsHidden(c(p))))switch(e.preventDefault(),c(this).data("gfstripesubmitting",!0),o.maybeAddSpinner(),o.stripe_payment){case"elements":o.form=c(this);var r=parseInt(c("#gform_source_page_number_"+o.formId).val(),10),t=parseInt(c("#gform_target_page_number_"+o.formId).val(),10);if(t<r&&0!==t&&(l=!0),o.isLastPage()&&!o.isCreditCardOnPage()||gformIsHidden(c(p))||l)return void c(this).submit();var i={name:c("#input_"+o.formId+"_"+o.ccFieldId+"_5").val(),address_line1:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_line1)),address_line2:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_line2)),address_city:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_city)),address_state:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_state)),address_zip:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_zip)),address_country:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_country)),currency:gform.applyFilters("gform_stripe_currency",o.currency,o.formId)};_.createToken(m,i).then(function(e){o.elementsResponseHandler(e)});break;case"checkout":0<window["gform_stripe_checkout_amount_"+o.formId]?(o.form=c(this),o.checkoutResponseHandler()):c(this).submit();break;case"stripe.js":var a=c(this),s="input_"+o.formId+"_"+o.ccFieldId+"_",n={number:a.find("#"+s+"1").val(),exp_month:a.find("#"+s+"2_month").val(),exp_year:a.find("#"+s+"2_year").val(),cvc:a.find("#"+s+"3").val(),name:a.find("#"+s+"5").val()};o.form=a,Stripe.card.createToken(n,function(e,r){o.responseHandler(e,r)})}})}},this.getBillingAddressMergeTag=function(e){return""===e?"":"{:"+e+"}"},this.responseHandler=function(e,r){for(var t=this.form,i="input_"+this.formId+"_"+this.ccFieldId+"_",a=["1","2_month","2_year","3","5"],s=0;s<a.length;s++){var n=t.find("#"+i+a[s]);if("1"==a[s]){var o=c.trim(n.val()),d=gformFindCardType(o);void 0!==this.cardLabels[d]&&(d=this.cardLabels[d]),t.append(c('<input type="hidden" name="stripe_credit_card_last_four" />').val(o.slice(-4))),t.append(c('<input type="hidden" name="stripe_credit_card_type" />').val(d))}}t.append(c('<input type="hidden" name="stripe_response" />').val(c.toJSON(r))),t.submit()},this.elementsResponseHandler=function(e){var r=this.form;c("#gf_stripe_response").length?c("#gf_stripe_response").val(c.toJSON(e)):r.append(c('<input type="hidden" name="stripe_response" id="gf_stripe_response" />').val(c.toJSON(e))),e.error?(this.displayStripeCardError(e),this.resetStripeStatus(r,this.formId,this.isLastPage())):(r.append(c('<input type="hidden" name="stripe_credit_card_last_four" id="gf_stripe_credit_card_last_four" />').val(e.token.card.last4)),r.append(c('<input type="hidden" name="stripe_credit_card_type" id="stripe_credit_card_type" />').val(e.token.card.brand)),r.submit())},this.checkoutResponseHandler=function(){var e=this.form,r=c.parseJSON(c("#gf_stripe_response").val());r.error||""===r?this.resetStripeStatus(e,this.formId,this.isLastPage()):(e.append(c('<input type="hidden" name="stripe_credit_card_last_four" id="gf_stripe_credit_card_last_four" />').val(r.card.last4)),e.append(c('<input type="hidden" name="stripe_credit_card_type" id="stripe_credit_card_type" />').val(r.card.brand)),e.submit())},this.isLastPage=function(){var e=c("#gform_target_page_number_"+this.formId);return!(0<e.length)||0==e.val()},this.isCreditCardOnPage=function(){var e=this.getCurrentPageNumber();return!this.ccPage||!e||this.ccPage==e},this.getCurrentPageNumber=function(){var e=c("#gform_source_page_number_"+this.formId);return 0<e.length&&e.val()},this.maybeAddSpinner=function(){if(!this.isAjax)if("function"==typeof gformAddSpinner)gformAddSpinner(this.formId);else{var e=this.formId;if(0==jQuery("#gform_ajax_spinner_"+e).length){var r=gform.applyFilters("gform_spinner_url",gf_global.spinnerUrl,e);gform.applyFilters("gform_spinner_target_elem",jQuery("#gform_submit_button_"+e+", #gform_wrapper_"+e+" .gform_next_button, #gform_send_resume_link_button_"+e),e).after('<img id="gform_ajax_spinner_'+e+'"  class="gform_ajax_spinner" src="'+r+'" alt="" />')}}},this.resetStripeStatus=function(e,r,t){c("#gf_stripe_response, #gf_stripe_credit_card_last_four, #stripe_credit_card_type").remove(),e.data("gfstripesubmitting",!1),c("#gform_ajax_spinner_"+r).remove(),t&&(window["gf_submitting_"+r]=!1)},this.displayStripeCardError=function(e){var r="#input_"+this.formId+"_"+this.ccFieldId+"_1";c(r).next(".validation_message").length||c(r).after('<div class="gfield_description validation_message"></div>');var t=c(r).next(".validation_message");e.error?(t.html(e.error.message),0<c("#gform_ajax_spinner_"+this.formId).length&&c("#gform_ajax_spinner_"+this.formId).remove()):t.html("")},this.updateCheckoutPaymentAmount=function(e){var r=this.formId;if("form_total"!==e.paymentAmount){var t=GFMergeTag.getMergeTagValue(r,e.paymentAmount,":price"),i=GFMergeTag.getMergeTagValue(r,e.paymentAmount,":qty");"string"==typeof t&&(t=GFMergeTag.getMergeTagValue(r,e.paymentAmount+".2",":price"),i=GFMergeTag.getMergeTagValue(r,e.paymentAmount+".3",":qty")),window["gform_stripe_checkout_amount_"+r]=t*i}e.hasOwnProperty("setupFee")&&(t=GFMergeTag.getMergeTagValue(r,e.setupFee,":price"),i=GFMergeTag.getMergeTagValue(r,e.setupFee,":qty"),"string"==typeof t&&(t=GFMergeTag.getMergeTagValue(r,e.setupFee+".2",":price"),i=GFMergeTag.getMergeTagValue(r,e.setupFee+".3",":qty")),window["gform_stripe_checkout_amount_"+r]+=t*i)},this.init()}}(jQuery);